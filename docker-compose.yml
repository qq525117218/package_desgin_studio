services:
  # =========================================
  # 1. 基础设施层 (MySQL & Redis & RabbitMQ)
  # =========================================
  mysql:
    image: mysql:8.4
    container_name: aims-mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    ports:
      - "${MYSQL_PORT}:3306" # 映射宿主机 33066 -> 容器 3306
    volumes:
      - mysql_data:/var/lib/mysql
      - ./backend/db/mysql/init:/docker-entrypoint-initdb.d:ro # 自动初始化 SQL
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci

  redis:
    image: redis:7.2
    container_name: aims-redis
    restart: always
    command: redis-server --requirepass ${REDIS_PASSWORD} --appendonly yes
    ports:
      - "${REDIS_PORT}:6379"
    volumes:
      - redis_data:/data

  rabbitmq:
    image: rabbitmq:3.13-management
    container_name: aims-rabbitmq
    restart: always
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD}
      RABBITMQ_DEFAULT_VHOST: ${RABBITMQ_VIRTUAL_HOST}
    ports:
      - "${RABBITMQ_PORT}:5672"
      - "${RABBITMQ_MGMT_PORT}:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq

  # =========================================
  # 2. 应用服务层 (Backend)
  # =========================================
  aims-api:
    build:
      context: ./backend
      dockerfile: AIMS.Server.Api/Dockerfile
    container_name: aims-api
    restart: always
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://0.0.0.0:8080
      # ⚠️ 关键修改：容器内连接数据库必须用服务名 "mysql" 而非 127.0.0.1
      # 端口使用容器内部端口 3306，而非映射出的 33066
      - MYSQL_CONNECTION_STRING=Server=mysql;Port=3306;Database=${MYSQL_DATABASE};Uid=${MYSQL_USER};Pwd=${MYSQL_PASSWORD};
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_PREFIX=${REDIS_PREFIX}
      - JWT_SECRET=${JWT_SECRET}
      - PLM_APP_KEY=${PLM_APP_KEY}
      - PLM_APP_SECRET=${PLM_APP_SECRET}
      - PLM_BASE_URL=${PLM_BASE_URL}
    depends_on:
      - mysql
      - redis
      - rabbitmq

  # =========================================
  # 3. 接入层 (Frontend + Nginx)
  # =========================================
  aims-web:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: aims-web
    restart: always
    ports:
      - "8082:80" # 浏览器访问入口
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf # 挂载 Nginx 配置
    depends_on:
      - aims-api

volumes:
  mysql_data:
  redis_data:
  rabbitmq_data:
